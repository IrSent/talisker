Logging
=======


This module provides a standard default way to do logging in python
apps, defaulting to a production set up.


  1. Log to stderr.

     * Simple, self contained application, no log file config
     * System writes to disk, process user doesn't need write perms
     * System handles logrotate
     * Works as a good default in dev.
     * PaaS friendly

  2. Log format

     * Defaults to:

         '%(asctime)s %(level)s %(name)s "%(message)"' + key/value pairs

     * preserves familiar dev friendly format
     * adds arbitrary key value pairs, according to logfmt standard
     * Tags iset at process level, context/request level, or per call
     * A service name tag is required upon initial configuration


Warnings
--------

We silence py.warnings logger by default. If debug mode is enabled, they
are logged, but 'bare', i.e no tags, just the warning.


Gunicorn
--------


There are some tools to support configuring gunicorn

  * custom gunicorn logger to improve the time resolution on access logs
    to include ms

  * default access log's format that is the default CLF but with the
    structured tags

Caveat: in order for gunicorns access and error logs to be correctly
configured, we need to initialise the logging setup *before* gunicorn
logs anything. This will ensure all logs are tagged properly. The
simplest way to do that is to use the python config file of gunicorn.

e.g. in config.py:

    # import defaults for access log and logger class
    from talisker.logging import access_log_format, logger_class

    # configure the logging
    from talisker.logging import configure_logging
    configure_logging('myservice')

    # normal gunicorn config here

Then

    $ gunicorn -c config.py app


Questions:

Should we merge gunicorns error logs with app logs?

Gunicorn user still needs perms to write access logs

django logs: store projects don't propagate django logs to standard
out, but did log them to disk. We can't replicate this easily.

Supporting additional custom logs, like sca's payment log?


Issues

 - need for debug config in gunicorn config sucks
 - gunicorn can't set custom logger w/statsd configured
 - gunicorn double logs exception tracebacks when app fails to start






